<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>ZMUSIC MML Editor</title>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <!-- CodeMirror JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <!-- Plaintext mode for CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/plaintext/plaintext.min.js"></script>
    <script src="dist/zmusic.js"></script>
    <script>
      // Global out() function to display output from zmusic.js calls such as out(UTF8ArrayToString(tty.output, 0));
      function out(text) {
        // Find the output container and append the text.
        var outputElement = document.getElementById("console-output");
        if (outputElement) {
          outputElement.textContent += text + "\n";
        } else {
          console.log(text);
        }
      }

      // Global CodeMirror editor variable.
      var editor;

      // Default MML code.
      const defaultMml = "; Default MML code\nv12 o5 l8 cdefgab>c";

      /**
       * Converts the MML code into text that is supported by OPM.
       * It removes any hexadecimal escape sequences matching the pattern "$0b##"
       * and filters out non-printable characters.
       *
       * @param {string} mml - The input MML code.
       * @returns {string} - The converted MML code, compatible with OPM.
       */
      function convertToOPM(mml) {
        // Remove any occurrence of "$0b00" explicitly.
        if (/\$0b00/i.test(mml)) {
          console.warn("Detected forbidden escape sequence $0b00. Removing it from the MML code.");
          mml = mml.replace(/\$0b00/gi, "");
        }
        // Remove any hexadecimal escape sequence "$0b" followed by two hex digits.
        mml = mml.replace(/\$0b[0-9A-Fa-f]{2}/g, "");
        // Remove any non-printable characters (excluding newlines).
        return mml.replace(/[^\x20-\x7E\n]/g, "");
      }

      // Initialize ZMUSIC and CodeMirror editor once the DOM content is loaded.
      document.addEventListener("DOMContentLoaded", function() {
        // Initialize CodeMirror using the textarea.
        editor = CodeMirror.fromTextArea(document.getElementById("mml-editor"), {
          mode: "plaintext",
          lineNumbers: true,
          theme: "default"
        });
        // Install ZMUSIC system.
        ZMUSIC.install().then(function() {
          const convertedMml = convertToOPM(defaultMml);
          console.log("Converted default MML:", convertedMml);
          editor.setValue(convertedMml);
        }).catch(function(err) {
          console.error("Error during ZMUSIC initialization:", err);
          document.getElementById("error-message").textContent = "Error initializing ZMUSIC: " + err;
        });
      });

      // Play function: get code from CodeMirror, convert it, and hand it to zmusic.js.
      function playMml() {
        const mmlCode = editor.getValue();
        const opmMmlCode = convertToOPM(mmlCode);
        if (/\$0b/.test(opmMmlCode)) {
          console.warn("Converted MML still contains $0b sequences:", opmMmlCode);
        }
        ZMUSIC.compileAndPlay(opmMmlCode);
      }
    </script>
    <style>
      /* Basic styling for CodeMirror editor */
      .CodeMirror {
        height: auto;
        border: 1px solid #ddd;
        font-size: 14px;
      }
      /* Styling for the output/log area */
      #console-output {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        background: #f9f9f9;
        height: 150px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h1>ZMUSIC MML Editor</h1>
    <!-- Display error messages if any occur -->
    <div id="error-message" style="color: red;"></div>
    <!-- Textarea that will be replaced by CodeMirror -->
    <textarea id="mml-editor"></textarea>
    <br>
    <button onclick="playMml()">Play</button>
    <button onclick="ZMUSIC.resume()">Unmute</button>
    <!-- Output area to display console messages from zmusic.js out() calls -->
    <pre id="console-output"></pre>
  </body>
</html>
