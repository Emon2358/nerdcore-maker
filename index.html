<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ZMUSIC Example with Error Log and Smartphone Optimizations</title>
  <script src="dist/zmusic.js"></script>
  <style>
    /* エラーログ表示用のスタイル */
    #errorLog {
      white-space: pre-wrap;
      background: #fdd;
      border: 1px solid #f00;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      margin-top: 20px;
    }
    /* スマホ向けにプレイスタートボタンを大きく表示 */
    @media only screen and (max-width: 600px) {
      #playButton {
        font-size: 24px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <button id="playButton">Play Music</button>
  <!-- エラーログ表示用のエリア -->
  <div id="errorLog"></div>
  
  <script>
    // エラーログを画面に出力するヘルパー関数
    function logError(message) {
      const errorLog = document.getElementById('errorLog');
      if (errorLog) {
        errorLog.textContent += message + "\n";
      }
    }

    // console.error を上書きして、エラーをページ上にも表示する
    (function() {
      const oldError = console.error;
      console.error = function(...args) {
        oldError.apply(console, args);
        logError(args.join(' '));
      };
    })();

    // グローバルなエラーイベントのキャッチ
    window.addEventListener('error', function(e) {
      logError('Error: ' + e.message + ' at ' + e.filename + ':' + e.lineno + ':' + e.colno);
    });

    // 未処理のPromiseエラーもキャッチ
    window.addEventListener('unhandledrejection', function(e) {
      logError('Unhandled rejection: ' + (e.reason && e.reason.stack ? e.reason.stack : e.reason));
    });

    // fetch API を使ってバイナリデータを取得するヘルパー関数
    async function fetchBinary(url) {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('Failed to load ' + url + ': status ' + response.status);
      }
      return response.arrayBuffer();
    }

    // AudioWorkletNode のサポート状況をチェック（サポートされていなければ警告）
    if (!window.AudioWorkletNode) {
      console.warn('AudioWorkletNode is not supported in this browser. Falling back to ScriptProcessorNode, which is deprecated.');
    }

    // ボタンのクリックでオーディオ再生処理を開始する
    document.getElementById('playButton').addEventListener('click', async function() {
      try {
        console.log("Playボタンがクリックされました。");

        // ZMUSIC ライブラリの AudioContext を再開する（または独自に作成して再開）
        if (window.ZMUSIC && typeof ZMUSIC.resume === 'function') {
          await ZMUSIC.resume();
          console.log("ZMUSIC.resume() により AudioContext を再開しました。");
        } else if (window.AudioContext) {
          // 万が一 ZMUSIC 内で管理されていなければ、自前で AudioContext の再開処理
          const ac = new AudioContext();
          if (ac.state === 'suspended') {
            await ac.resume();
            console.log("新規 AudioContext を生成し、再開しました。");
          }
        }

        // ZMDファイルの取得
        console.log("ZMDファイルを読み込み中…");
        const zmdData = await fetchBinary('data/bgm1.zmd');
        console.log("ZMDファイルの読み込みに成功しました。");

        // ZMUSIC のインストール
        console.log("ZMUSIC をインストール中…");
        await ZMUSIC.install();
        console.log("ZMUSIC のインストールが完了しました。");

        // 再生開始
        console.log("音楽再生を開始します。");
        ZMUSIC.play(zmdData);
      } catch (error) {
        console.error('Error during loading or playing music:', error);
      }
    });
  </script>
</body>
</html>
