<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Z-Music2 Sample</title>
  <!-- wasmファイルの配置パスを指定 -->
  <script>
    var Module = {
      locateFile: function (path, prefix) {
        if (path.endsWith('.wasm')) {
          return 'dist/' + path;
        }
        return prefix + path;
      }
      // AudioContextは後で設定します
    };
  </script>
</head>
<body>
  <button id="startButton">Start Audio</button>
  <script>
    // XHRで ArrayBuffer を取得するための Promise ラッパー
    function xhr(url) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = () => {
          resolve(xhr.response);
          xhr.abort();
        };
        xhr.onerror = (e) => reject(e);
        xhr.send();
      });
    }

    document.getElementById('startButton').addEventListener('click', function() {
      // ユーザー操作後に AudioContext を作成し、再開する
      var myAudioContext = new (window.AudioContext || window.webkitAudioContext)();
      myAudioContext.resume().then(() => {
        console.log("AudioContext resumed");
        // ZMUSIC が利用する AudioContext として設定
        Module.context = myAudioContext;
        // 手動で作成する AudioNode も同じコンテキストから作成
        var myGainNode = myAudioContext.createGain();

        // 動的に zmusic.js (distフォルダ内) を読み込む
        var script = document.createElement('script');
        script.src = "dist/zmusic.js";
        script.onload = function() {
          // zmusic.js 読み込み後、ZMUSIC の初期設定を実行
          ZMUSIC.install(['ZMUSIC208.X']);
          ZMUSIC.install(null, { buffer: 8192 });
          ZMUSIC.install(null, { context: myAudioContext });
          // ZMUSIC 内部の出力ノードと、手動の GainNode を接続
          ZMUSIC.connect(myGainNode);

          // 音楽データ（.zms ファイル）の読み込みと再生
          Promise.all([
            ZMUSIC.install(),
            xhr('data/bgm1.zms')
          ]).then(results => {
            ZMUSIC.compileAndPlay(results[1]);
          }).catch(err => {
            console.error("Error loading audio:", err);
          });
        };
        script.onerror = function() {
          console.error("Failed to load zmusic.js");
        };
        document.body.appendChild(script);
      }).catch(err => {
        console.error("AudioContext resume error:", err);
      });
    });
  </script>
</body>
</html>
