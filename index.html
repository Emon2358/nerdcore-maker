<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Vue + Ace Editor + ZMUSIC Example</title>
  <!-- Vue.js (Vue 3) の読み込み -->
  <script src="https://unpkg.com/vue@3"></script>
  <!-- Ace Editor の読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js" integrity="sha512-bsdv4I2I7oJU3iLt0+4b0f0xkxKfygS/dh5qvyF/02Egejr3DWi1bK7LzzN5fiHJCUcmGwB5x2ufdCTIrs0alA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- ZMUSIC ライブラリ -->
  <script src="dist/zmusic.js"></script>
  <style>
    #editor {
      height: 300px;
      width: 100%;
      border: 1px solid #ccc;
    }
    #errorLog {
      white-space: pre-wrap;
      background: #fdd;
      border: 1px solid #f00;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      margin-top: 20px;
    }
    button {
      font-size: 16px;
      padding: 10px 20px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="editor"></div>
    <button @click="playMusic">Play Music</button>
    <div id="errorLog">{{ errorLog }}</div>
  </div>
  
  <script>
    const { createApp } = Vue;
    
    createApp({
      data() {
        return {
          editor: null,
          errorLog: ''
        }
      },
      methods: {
        logError(message) {
          this.errorLog += message + "\n";
          console.error(message);
        },
        async playMusic() {
          try {
            console.log("Playボタンがクリックされました。");
            
            // Ace エディタからテキストを取得
            const text = this.editor.getValue();
            console.log("Aceエディタから取得したテキスト:", text);
            
            // テキストを ArrayBuffer に変換（zmusic.js がバイナリデータを期待している場合）
            const encoder = new TextEncoder();
            const buffer = encoder.encode(text).buffer;
            
            // AudioContext の再開（ZMUSIC.resume() が実装されている場合）
            if (window.ZMUSIC && typeof ZMUSIC.resume === 'function') {
              await ZMUSIC.resume();
              console.log("ZMUSIC.resume() により AudioContext を再開しました。");
            }
            
            // ZMUSIC のインストール
            console.log("ZMUSIC をインストール中…");
            await ZMUSIC.install();
            console.log("ZMUSIC のインストールが完了しました。");
            
            // （もし実装されていれば）音量の設定
            if (ZMUSIC.setVolume) {
              ZMUSIC.setVolume(1.0);
              console.log("Volume set to 1.0");
            }
            
            // 再生開始
            console.log("音楽再生を開始します。");
            ZMUSIC.play(buffer);
            
            // 再生後、AudioContext の状態を確認（デバッグ用）
            setTimeout(() => {
              if (ZMUSIC.getAudioContext) {
                const ac = ZMUSIC.getAudioContext();
                console.log("再生後の AudioContext state:", ac.state);
              }
            }, 3000);
          } catch (error) {
            this.logError('Error during playing music: ' + error);
          }
        }
      },
      mounted() {
        // Ace Editor の初期化
        this.editor = ace.edit("editor");
        this.editor.setTheme("ace/theme/monokai");
        // 編集可能なテキストモードに設定
        this.editor.session.setMode("ace/mode/text");
        // 明示的に編集可能に設定（デフォルトは true のはずですが念のため）
        this.editor.setReadOnly(false);
        // 初期コンテンツの設定。-1 を指定するとカーソル位置が最初に移動しません。
        this.editor.setValue("// ここに MML / ZMS の内容を記述\n", -1);
        
        // グローバルエラーのキャッチ（オプション）
        window.addEventListener('error', (e) => {
          this.logError('Error: ' + e.message + ' at ' + e.filename + ':' + e.lineno + ':' + e.colno);
        });
        window.addEventListener('unhandledrejection', (e) => {
          this.logError('Unhandled rejection: ' + (e.reason && e.reason.stack ? e.reason.stack : e.reason));
        });
      }
    }).mount('#app');
  </script>
</body>
</html>
